Internal Zabbix documentation (in Polish):
https://confluence.redge.com/display/DSW/Zabbix

## Repository contents
- **Agent:** role `zabbix_agent3` (playbook: `install_zabbix_agent.yml`) installs Zabbix Agent 2 version 7.0 with PSK and autoregistration metadata. By default it sets `HostMetadata=groups=Linux passive`, so each new machine appears in the autoregistration action as a member of that group (you can override the groups with `zabbix_agent_autoreg_groups`).
- **Proxy:** role `zabbix_proxy2` (playbook: `install_zabbix_proxy.yml`) installs Zabbix Proxy 7.0 on SQLite with PSK and a unique `TLSPSKIdentity` per host. After deployment, the host must exist on the Zabbix server (manually or via API) with the same identity and PSK stored in the fact `zabbix_proxy_tls_psk_value`.
- **No server role:** the repository does not include a role or playbook for installing/configuring the Zabbix server itself; prepare the server separately.

Example proxy playbook usage:

```bash
ansible-playbook -i hosts install_zabbix_proxy.yml
```

## Autoregistration of new hosts
- **Agents:** the autoregistration action is created by the `zabbix_server` role and filters `HostMetadata` containing `groups=`. The default PSK (`tLSPSKIdentity: zabbix-autoregistration`) is generated automatically on the host, and groups/templates are enforced by the server action.
- **Proxies:** the `zabbix_server` role can register proxies through the API, reading the PSK from the fact `zabbix_proxy_tls_psk_value` generated on the proxy. If you prefer to register proxies manually/API, use the same `Hostname`, `TLSPSKIdentity`, and PSK stored in `/etc/zabbix/zabbix-proxy.key`.

## Playbook usage
- Server (API configuration, groups, autoregistration action, proxy registration):
  ```bash
  ansible-playbook -i hosts install_zabbix_server.yml \
    -e zabbix_server_url=https://your.zabbix/ui \
    -e zabbix_server_login_user=Admin \
    -e zabbix_server_login_password=secret
  ```
  - Variable `zabbix_server_proxy_psk_variable` controls which fact/inventory variable stores the PSK generated by the proxy role (`zabbix_proxy_tls_psk_value` by default).
  - The `community.zabbix` collection is required on the Ansible control node.
- Agents: `ansible-playbook -i hosts install_zabbix_agent.yml`
- Proxy: `ansible-playbook -i hosts install_zabbix_proxy.yml`
  - Optionally: `-e proxy_auth={token}` if HTTP/HTTPS proxy authentication is required
