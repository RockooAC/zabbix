- name: Install Zabbix agent on proxy host
  when: zabbix_proxy_agent_enabled | bool
  block:
    - name: Remove legacy Zabbix agent (v1)
      ansible.builtin.apt:
        name: zabbix-agent
        state: absent
      become: true

    - name: Install Zabbix agent packages
      ansible.builtin.apt:
        name: "{{ zabbix_proxy_agent_packages }}"
        state: present
        update_cache: false
      become: true

    - name: Ensure /etc/zabbix exists for agent configuration
      ansible.builtin.file:
        path: /etc/zabbix
        state: directory
        owner: zabbix
        group: zabbix
        mode: '0750'
      become: true

    - name: Ensure agent PSK is present with fixed value
      ansible.builtin.copy:
        content: "{{ zabbix_proxy_agent_tls_psk_value }}"
        dest: "{{ zabbix_proxy_agent_tls_psk_file }}"
        owner: zabbix
        group: zabbix
        mode: '0640'
      become: true
      notify: Restart zabbix-agent2

    - name: Render zabbix_agent2.conf for proxy host
      ansible.builtin.template:
        src: zabbix_agent2.conf.j2
        dest: /etc/zabbix/zabbix_agent2.conf
        owner: zabbix
        group: zabbix
        mode: '0644'
      become: true
      notify: Restart zabbix-agent2
      register: proxy_agent_cfg

    - name: Keep legacy agentd config in sync (proxy)
      ansible.builtin.template:
        src: zabbix_agent2.conf.j2
        dest: /etc/zabbix/zabbix_agentd.conf
        owner: zabbix
        group: zabbix
        mode: '0644'
      become: true
      register: proxy_agentd_cfg

    - name: Validate proxy agent configuration
      ansible.builtin.command: "zabbix_agent2 -T -c /etc/zabbix/zabbix_agent2.conf"
      changed_when: false
      when: proxy_agent_cfg is changed
      become: true

    - name: Ensure Zabbix agent2 is running on proxy
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: restarted
        enabled: true
        daemon_reload: true
      become: true
