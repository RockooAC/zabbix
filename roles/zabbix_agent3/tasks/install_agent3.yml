---
- name: Remove legacy Zabbix agent (v1)
  ansible.builtin.apt:
    name: zabbix-agent
    state: absent
  become: true

- name: Remove old repository files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/zabbix.list
    - /etc/apt/sources.list.d/zabbix-fallback.list
  become: true

- name: Ensure keyrings directory exists
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Ensure gnupg is installed
  ansible.builtin.apt:
    name: gnupg
    state: present
  become: true

- name: Remove outdated Zabbix repository keys
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/share/keyrings/zabbix-official-repo.key
    - /usr/share/keyrings/zabbix-official-repo.gpg
  become: true

- name: Download and convert Zabbix repository key
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://repo.zabbix.com/zabbix-official-repo.key | gpg --dearmor -o /usr/share/keyrings/zabbix-official-repo.gpg
  args:
    executable: /bin/bash
  become: true

- name: Determine repository codename
  ansible.builtin.set_fact:
    zabbix_repo_codename: >-
      {{
        (ansible_lsb.codename if ansible_lsb.codename is defined else
         ansible_distribution_release if ansible_distribution_release is defined else
         'jammy')
      }}

- name: Create Zabbix repository file
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/zabbix.list
    mode: '0644'
    content: |
      deb [arch=amd64 signed-by=/usr/share/keyrings/zabbix-official-repo.gpg] https://repo.zabbix.com/zabbix/{{ zabbix_agent_version }}/ubuntu {{ zabbix_repo_codename }} main
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  register: apt_update_result
  retries: 3
  delay: 5
  until: apt_update_result is succeeded
  become: true

- name: Install Zabbix packages
  ansible.builtin.apt:
    name: "{{ zabbix_packages }}"
    state: present
    update_cache: false
  become: true

- name: Ensure Zabbix Agent 2 service is running
  ansible.builtin.service:
    name: zabbix-agent2
    state: started
    enabled: true
  become: true
